# Visual Mapper - Production Docker Compose
# For end-users installing on a new machine
# Run: docker-compose -f docker-compose.prod.yml up -d

services:
  # MQTT Broker - Message bus for Android <-> Server communication
  mqtt:
    image: eclipse-mosquitto:2
    container_name: visualmapper-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"    # MQTT
      - "9001:9001"    # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - mqtt-data:/mosquitto/data
      - mqtt-log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Main Server - FastAPI backend for Visual Mapper
  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: visualmapper-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      mqtt:
        condition: service_healthy
    environment:
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
    volumes:
      # Persistent data - bind mounts to host directories
      - ./data:/app/data
      - ./config:/app/config
      - ./data/adb:/home/visualmapper/.android
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Named volumes for MQTT persistence only
volumes:
  mqtt-data:
  mqtt-log:

# Network for internal communication
networks:
  default:
    name: visualmapper-network
