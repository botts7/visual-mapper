version: '3.8'

# Visual Mapper Backend Services
# Run: docker-compose up -d
# Stop: docker-compose down

services:
  # MQTT Broker - Message bus for Android â†” Server communication
  mqtt:
    image: eclipse-mosquitto:2
    container_name: visualmapper-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"    # MQTT
      - "8883:8883"    # MQTT over SSL/TLS
      - "9001:9001"    # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - ./mosquitto/certs:/mosquitto/certs:ro   # SSL certificates
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Main Server - FastAPI backend for Visual Mapper
  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: visualmapper-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      mqtt:
        condition: service_healthy
    environment:
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - ML_SERVER_ENABLED=true
    volumes:
      - ./data:/app/data
      - ./config:/app/config                     # Navigation graphs and app config
      - ./www:/app/www:ro
      - ./data/adb:/home/visualmapper/.android  # ADB keys (persisted for pairing)
      # Hot-reload Python code (dev mode)
      - ./server.py:/app/server.py:ro
      - ./routes:/app/routes:ro
      - ./services:/app/services:ro
      - ./utils:/app/utils:ro
      # Core modules
      - ./adb_bridge.py:/app/adb_bridge.py:ro
      - ./sensor_manager.py:/app/sensor_manager.py:ro
      - ./sensor_models.py:/app/sensor_models.py:ro
      - ./text_extractor.py:/app/text_extractor.py:ro
      - ./mqtt_manager.py:/app/mqtt_manager.py:ro
      - ./sensor_updater.py:/app/sensor_updater.py:ro
      - ./ha_device_classes.py:/app/ha_device_classes.py:ro
      # Flow system
      - ./flow_models.py:/app/flow_models.py:ro
      - ./flow_manager.py:/app/flow_manager.py:ro
      - ./flow_executor.py:/app/flow_executor.py:ro
      - ./flow_scheduler.py:/app/flow_scheduler.py:ro
      - ./flow_execution_history.py:/app/flow_execution_history.py:ro
      - ./performance_monitor.py:/app/performance_monitor.py:ro
      # Navigation system
      - ./navigation_models.py:/app/navigation_models.py:ro
      - ./navigation_miner.py:/app/navigation_miner.py:ro
      # Screenshot & icons
      - ./screenshot_stitcher.py:/app/screenshot_stitcher.py:ro
      - ./app_icon_extractor.py:/app/app_icon_extractor.py:ro
      - ./playstore_icon_scraper.py:/app/playstore_icon_scraper.py:ro
      - ./device_icon_scraper.py:/app/device_icon_scraper.py:ro
      - ./icon_background_fetcher.py:/app/icon_background_fetcher.py:ro
      - ./app_name_background_fetcher.py:/app/app_name_background_fetcher.py:ro
      - ./app_label_extractor.py:/app/app_label_extractor.py:ro
      # Streaming & helpers
      - ./stream_manager.py:/app/stream_manager.py:ro
      - ./adb_helpers.py:/app/adb_helpers.py:ro
      - ./navigation_manager.py:/app/navigation_manager.py:ro
      - ./navigation_mqtt_handler.py:/app/navigation_mqtt_handler.py:ro
      # Screenshot stitching modules
      - ./ss_modules:/app/ss_modules:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ML Training Server - Q-Learning model training with NPU/GPU acceleration
  ml-training:
    build:
      context: .
      dockerfile: Dockerfile.ml
    container_name: visualmapper-ml
    restart: unless-stopped
    depends_on:
      mqtt:
        condition: service_healthy
    environment:
      - MQTT_BROKER=mqtt
      - MQTT_PORT=1883
      - USE_NPU=true
    volumes:
      - ./data:/app/data
    # No port exposed - communicates via MQTT only
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python"]
      interval: 30s
      timeout: 10s
      retries: 3

# Named volumes for persistence
volumes:
  mqtt-data:
  app-data:

# Network for internal communication
networks:
  default:
    name: visualmapper-network
