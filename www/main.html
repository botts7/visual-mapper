<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="0.0.3">
    <meta name="version" content="0.0.3" data-build="2025-12-22">
    <title>Dashboard - Visual Mapper</title>
    <link rel="stylesheet" href="css/styles.css?v=0.0.3">
</head>
<body>
    <nav>
        <ul>
            <!-- High priority - always visible -->
            <li class="nav-priority-high"><a href="main.html">Dashboard</a></li>
            <li class="nav-priority-high"><a href="devices.html">Devices</a></li>
            <li class="nav-priority-high"><a href="sensors.html">Sensors</a></li>

            <!-- Medium priority - hidden on mobile -->
            <li class="nav-priority-med"><a href="actions.html">Actions</a></li>
            <li class="nav-priority-med"><a href="flows.html">Flows</a></li>
            <li class="nav-priority-med"><a href="diagnostic.html">Diagnostics</a></li>

            <!-- Low priority - hidden on mobile and tablet -->
            <li class="nav-priority-low"><a href="index.html">Home</a></li>
            <li class="nav-priority-low"><a href="dev.html">Dev Tools</a></li>

            <li class="version">v0.0.4</li>
            <li id="themeToggleContainer"></li>
        </ul>
    </nav>

    <div class="container">
        <div class="card">
            <h1>Visual Mapper Dashboard</h1>
            <p>Home Assistant Android Device Monitoring - Phase 3</p>
        </div>

        <!-- System Status -->
        <div class="card">
            <h2>System Status</h2>
            <p><strong>Backend:</strong> <span id="backend-status">Checking...</span></p>
            <p><strong>Version:</strong> 0.0.4</p>
            <p><strong>Phase:</strong> 3 - Sensor Creation Complete</p>
            <p><strong>API Base:</strong> <span id="api-base"></span></p>
        </div>

        <!-- Connected Devices -->
        <div class="card">
            <h2>Connected Devices</h2>
            <div id="devicesContainer">
                <p class="status warning">Loading devices...</p>
            </div>
        </div>

        <!-- Active Sensors -->
        <div class="card">
            <h2>Active Sensors</h2>
            <div id="sensorsContainer">
                <p class="status warning">Loading sensors...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>Quick Actions</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="devices.html" class="btn">Manage Devices</a>
                <a href="sensors.html" class="btn">Manage Sensors</a>
                <a href="diagnostic.html" class="btn btn-secondary">Diagnostic Tools</a>
            </div>
        </div>
    </div>

    <script type="module">
        import APIClient from './js/modules/api-client.js?v=0.0.4';
        import ThemeToggle from './js/modules/theme-toggle.js?v=0.0.4';
        import MobileNav from './js/modules/mobile-nav.js?v=0.0.4';

        const apiClient = new APIClient();
        const themeToggle = new ThemeToggle();
        const mobileNav = new MobileNav();

        // Apply theme immediately
        themeToggle.apply();

        // Initialize mobile navigation
        mobileNav.init();

        // Add theme toggle button to nav
        const themeToggleContainer = document.getElementById('themeToggleContainer');
        if (themeToggleContainer) {
            const toggleButton = themeToggle.createToggleButton((newTheme) => {
                console.log('Theme changed to:', newTheme);
            });
            themeToggleContainer.appendChild(toggleButton);
        }

        // Show API base
        document.getElementById('api-base').textContent = window.API_BASE || '/api';

        // Check backend health
        async function checkBackend() {
            try {
                const response = await apiClient.get('/health');
                document.getElementById('backend-status').textContent = `‚úÖ Running (${response.version})`;
                document.getElementById('backend-status').style.color = 'var(--success-color)';
            } catch (error) {
                document.getElementById('backend-status').textContent = '‚ùå Not responding';
                document.getElementById('backend-status').style.color = 'var(--error-color)';
                console.error('[Dashboard] Backend health check failed:', error);
            }
        }

        // Load devices
        async function loadDevices() {
            const container = document.getElementById('devicesContainer');
            try {
                const response = await apiClient.get('/adb/devices');
                const devices = response.devices || [];

                if (devices.length === 0) {
                    container.innerHTML = '<p class="status warning">No devices connected. <a href="devices.html">Connect a device</a></p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';
                for (const device of devices) {
                    const statusBadge = device.state === 'device'
                        ? '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Connected</span>'
                        : '<span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Offline</span>';

                    // Parse activity to show just app name
                    let appName = 'No active app';
                    if (device.current_activity && device.current_activity !== 'Unknown' && device.current_activity !== 'Offline') {
                        // Extract package/activity name (e.g., "com.sec.android.app.launcher/...")
                        const parts = device.current_activity.split('/');
                        if (parts.length > 0) {
                            appName = parts[0].split('.').pop() || device.current_activity;
                        }
                    }

                    html += `
                        <div style="border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; background: var(--card-background);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <strong>${device.id}</strong><br>
                                    <small style="color: var(--text-secondary);">
                                        üì± ${device.model || 'Unknown model'}<br>
                                        üì≤ Active: <strong>${appName}</strong>
                                    </small>
                                </div>
                                <div>${statusBadge}</div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('[Dashboard] Failed to load devices:', error);
                container.innerHTML = '<p class="status error">Failed to load devices</p>';
            }
        }

        // Load sensors
        async function loadSensors() {
            const container = document.getElementById('sensorsContainer');
            try {
                // Get all devices first
                const devicesResponse = await apiClient.get('/adb/devices');
                const devices = devicesResponse.devices || [];

                // Load sensors for each device IN PARALLEL
                const sensorPromises = devices.map(device =>
                    apiClient.get(`/sensors/${device.id}`)
                        .then(response => response.sensors || [])
                        .catch(error => {
                            console.error(`[Dashboard] Failed to load sensors for ${device.id}:`, error);
                            return [];
                        })
                );

                // Wait for all API calls to complete in parallel
                const results = await Promise.all(sensorPromises);

                // Flatten and filter enabled sensors
                let allSensors = [];
                results.forEach(sensors => {
                    allSensors.push(...sensors.filter(s => s.enabled));
                });

                if (allSensors.length === 0) {
                    container.innerHTML = '<p class="status warning">No active sensors. <a href="devices.html">Create sensors</a></p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 10px;">';
                for (const sensor of allSensors.slice(0, 5)) { // Show first 5
                    const currentValue = sensor.current_value
                        ? `${sensor.current_value}${sensor.unit_of_measurement || ''}`
                        : '<em style="color: var(--text-secondary);">Not yet updated</em>';

                    html += `
                        <div style="border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; background: var(--card-background);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${sensor.icon ? sensor.icon + ' ' : ''}${sensor.friendly_name}</strong><br>
                                    <small style="color: var(--text-secondary);">${sensor.device_id}</small>
                                </div>
                                <div style="text-align: right;">
                                    ${currentValue}
                                </div>
                            </div>
                        </div>
                    `;
                }
                if (allSensors.length > 5) {
                    html += `<p style="text-align: center; margin: 10px 0;"><a href="sensors.html">View all ${allSensors.length} sensors</a></p>`;
                }
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('[Dashboard] Failed to load sensors:', error);
                container.innerHTML = '<p class="status error">Failed to load sensors</p>';
            }
        }

        // Initial load
        checkBackend();
        loadDevices();
        loadSensors();

        // Refresh every 30 seconds
        setInterval(() => {
            loadDevices();
            loadSensors();
        }, 30000);
    </script>
</body>
</html>
