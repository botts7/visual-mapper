<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="0.0.3">
    <title>Flow Management - Visual Mapper</title>
    <link rel="stylesheet" href="css/styles.css?v=0.0.3">
    <style>
        .flow-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .flow-header h1 {
            margin: 0;
            color: var(--text-primary);
        }

        .flow-actions {
            display: flex;
            gap: 10px;
        }

        .flow-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .flow-table thead {
            background: #3b82f6;
            color: white;
        }

        .flow-table th,
        .flow-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .flow-table tbody tr:hover {
            background: var(--hover);
        }

        .flow-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .flow-status.enabled {
            background: #22c55e;
            color: white;
        }

        .flow-status.disabled {
            background: #94a3b8;
            color: white;
        }

        .flow-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .flow-row-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--hover);
        }

        .btn-icon.execute {
            color: #3b82f6;
            border-color: #3b82f6;
            position: relative;
        }

        .btn-icon.execute:hover {
            background: #3b82f6;
            color: white;
        }

        .btn-icon.execute.running {
            background: #10b981;
            color: white;
            border-color: #10b981;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .flow-status.running {
            background: #10b981;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .btn-icon.delete {
            color: #ef4444;
            border-color: #ef4444;
        }

        .btn-icon.delete:hover {
            background: #ef4444;
            color: white;
        }

        .btn-icon.edit {
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .btn-icon.edit:hover {
            background: #f59e0b;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        /* Edit Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #0f172a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #0f172a;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            background: #ffffff;
            color: #0f172a;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
        }

        .modal-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .modal-tab:hover {
            color: #0f172a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px;
            min-height: 500px;
            height: 60vh;
            max-height: none;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            white-space: pre;
        }

        .json-editor-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="main.html">Dashboard</a></li>
            <li><a href="devices.html">Devices</a></li>
            <li><a href="sensors.html">Sensors</a></li>
            <li><a href="actions.html">Actions</a></li>
            <li><a href="flows.html">Flows</a></li>
            <li><a href="diagnostic.html">Diagnostics</a></li>
            <li><a href="dev.html">Dev Tools</a></li>
            <li class="version">v0.0.5</li>
        </ul>
    </nav>

    <div class="flow-container">
        <div class="flow-header">
            <h1>Flow Management</h1>
            <div class="flow-actions">
                <button class="btn btn-primary" onclick="window.location.href='flow-wizard.html'">
                    ✨ Create Flow Wizard
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='create-flow.html'">
                    Advanced
                </button>
                <button class="btn btn-secondary" onclick="loadFlows()">
                    Refresh
                </button>
            </div>
        </div>

        <div class="flow-stats" id="flowStats">
            <div class="stat-card">
                <h3>Total Flows</h3>
                <div class="value" id="statTotal">0</div>
            </div>
            <div class="stat-card">
                <h3>Enabled</h3>
                <div class="value" id="statEnabled">0</div>
            </div>
            <div class="stat-card">
                <h3>Queue Depth</h3>
                <div class="value" id="statQueueDepth">0</div>
            </div>
            <div class="stat-card">
                <h3>Success Rate</h3>
                <div class="value" id="statSuccessRate">-</div>
            </div>
        </div>

        <div id="flowTableContainer">
            <table class="flow-table" id="flowTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Device</th>
                        <th>Steps</th>
                        <th>Interval</th>
                        <th>Status</th>
                        <th>Last Run</th>
                        <th>Success</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="flowTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            Loading flows...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Flow Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Flow</h2>
            </div>

            <!-- Tabs -->
            <div class="modal-tabs">
                <button type="button" class="modal-tab active" onclick="switchEditTab('basic')">Basic Settings</button>
                <button type="button" class="modal-tab" onclick="switchEditTab('advanced')">Advanced (JSON)</button>
            </div>

            <form id="editFlowForm">
                <!-- Basic Settings Tab -->
                <div id="tabBasic" class="tab-content active">
                    <div class="form-group">
                        <label for="editFlowName">Flow Name *</label>
                        <input type="text" id="editFlowName" required>
                    </div>
                    <div class="form-group">
                        <label for="editFlowDescription">Description</label>
                        <textarea id="editFlowDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFlowInterval">Update Interval (seconds)</label>
                        <input type="number" id="editFlowInterval" min="5" required>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="editFlowEnabled">
                            <label for="editFlowEnabled" style="margin: 0">Flow Enabled</label>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="tabAdvanced" class="tab-content">
                    <div class="json-editor-warning">
                        ⚠️ <strong>Advanced Mode:</strong> Edit flow JSON directly. Changes must be valid JSON or save will fail.
                    </div>
                    <div class="form-group">
                        <label for="editFlowJSON">Flow JSON</label>
                        <textarea id="editFlowJSON" class="json-editor"></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import FlowManager from './js/modules/flow-manager.js?v=0.0.9';
        import { showToast } from './js/modules/toast.js?v=0.0.9';

        // Make functions globally available
        window.flowManager = new FlowManager();
        window.showToast = showToast;

        let flows = [];

        async function loadFlows() {
            try {
                flows = await window.flowManager.getFlows();
                renderFlowTable();
                updateStats();
            } catch (error) {
                console.error('Failed to load flows:', error);
                showToast('Failed to load flows: ' + error.message, 'error');
            }
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flowTableBody');

            if (flows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p>No flows configured yet.</p>
                            <p>Flows will appear here once you create them via the API.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = flows.map(flow => `
                <tr>
                    <td><strong>${escapeHtml(flow.name)}</strong></td>
                    <td><code>${escapeHtml(flow.device_id)}</code></td>
                    <td>${flow.steps.length} steps</td>
                    <td>${flow.update_interval_seconds}s</td>
                    <td>
                        <span class="flow-status ${flow.enabled ? 'enabled' : 'disabled'}">
                            ${flow.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>${formatDateTime(flow.last_executed)}</td>
                    <td>${formatSuccessRate(flow)}</td>
                    <td>
                        <div class="flow-row-actions">
                            <button class="btn-icon execute"
                                    onclick="executeFlow('${flow.device_id}', '${flow.flow_id}')"
                                    title="Execute Now">
                                ▶
                            </button>
                            <button class="btn-icon edit"
                                    onclick="editFlow('${flow.device_id}', '${flow.flow_id}')"
                                    title="Edit">
                                ✏
                            </button>
                            <button class="btn-icon delete"
                                    onclick="deleteFlow('${flow.device_id}', '${flow.flow_id}', '${escapeHtml(flow.name)}')"
                                    title="Delete">
                                ✕
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function updateStats() {
            const totalFlows = flows.length;
            const enabledFlows = flows.filter(f => f.enabled).length;

            document.getElementById('statTotal').textContent = totalFlows;
            document.getElementById('statEnabled').textContent = enabledFlows;

            // Get metrics for queue depth and success rate
            try {
                const metricsData = await window.flowManager.getMetrics();
                const metrics = metricsData.all_devices || {};

                let totalQueueDepth = 0;
                let totalSuccessRate = 0;
                let deviceCount = 0;

                Object.values(metrics).forEach(m => {
                    if (m.queue_depth !== undefined) {
                        totalQueueDepth += m.queue_depth;
                        deviceCount++;
                    }
                    if (m.success_rate !== undefined) {
                        totalSuccessRate += m.success_rate;
                    }
                });

                document.getElementById('statQueueDepth').textContent = totalQueueDepth;

                if (deviceCount > 0) {
                    const avgSuccessRate = (totalSuccessRate / deviceCount) * 100;
                    document.getElementById('statSuccessRate').textContent =
                        avgSuccessRate.toFixed(1) + '%';
                } else {
                    document.getElementById('statSuccessRate').textContent = '-';
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        async function executeFlow(deviceId, flowId) {
            try {
                await window.flowManager.executeFlow(deviceId, flowId);
                showToast('Flow execution scheduled', 'success');
                await loadFlows();
            } catch (error) {
                showToast('Failed to execute flow: ' + error.message, 'error');
            }
        }

        async function deleteFlow(deviceId, flowId, flowName) {
            if (!confirm(`Are you sure you want to delete flow "${flowName}"?`)) {
                return;
            }

            try {
                await window.flowManager.deleteFlow(deviceId, flowId);
                showToast('Flow deleted successfully', 'success');
                await loadFlows();
            } catch (error) {
                showToast('Failed to delete flow: ' + error.message, 'error');
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        function formatSuccessRate(flow) {
            if (flow.execution_count === 0) return '-';
            const rate = (flow.success_count / flow.execution_count) * 100;
            return `${flow.success_count}/${flow.execution_count} (${rate.toFixed(0)}%)`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let editingFlow = null;
        let currentEditTab = 'basic';

        function switchEditTab(tabName) {
            currentEditTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'basic') {
                document.getElementById('tabBasic').classList.add('active');
                // Sync basic form from JSON if user was editing JSON
                syncBasicFormFromJSON();
            } else if (tabName === 'advanced') {
                document.getElementById('tabAdvanced').classList.add('active');
                // Sync JSON from basic form
                syncJSONFromBasicForm();
            }
        }

        function syncJSONFromBasicForm() {
            if (!editingFlow) return;

            // Build updated flow object from basic form
            const updatedFlow = {
                ...editingFlow.flow,
                name: document.getElementById('editFlowName').value,
                description: document.getElementById('editFlowDescription').value,
                update_interval_seconds: parseInt(document.getElementById('editFlowInterval').value),
                enabled: document.getElementById('editFlowEnabled').checked
            };

            // Update JSON editor
            document.getElementById('editFlowJSON').value = JSON.stringify(updatedFlow, null, 2);
        }

        function syncBasicFormFromJSON() {
            if (!editingFlow) return;

            try {
                const flowData = JSON.parse(document.getElementById('editFlowJSON').value);
                document.getElementById('editFlowName').value = flowData.name || '';
                document.getElementById('editFlowDescription').value = flowData.description || '';
                document.getElementById('editFlowInterval').value = flowData.update_interval_seconds || 60;
                document.getElementById('editFlowEnabled').checked = flowData.enabled !== false;
            } catch (error) {
                console.warn('Failed to sync basic form from JSON:', error);
            }
        }

        function editFlow(deviceId, flowId) {
            // Find the flow to edit
            const flow = flows.find(f => f.device_id === deviceId && f.flow_id === flowId);
            if (!flow) {
                showToast('Flow not found', 'error');
                return;
            }

            // Store reference for saving
            editingFlow = { deviceId, flowId, flow };

            // Populate basic form
            document.getElementById('editFlowName').value = flow.name || '';
            document.getElementById('editFlowDescription').value = flow.description || '';
            document.getElementById('editFlowInterval').value = flow.update_interval_seconds || 60;
            document.getElementById('editFlowEnabled').checked = flow.enabled !== false;

            // Populate JSON editor
            document.getElementById('editFlowJSON').value = JSON.stringify(flow, null, 2);

            // Reset to basic tab
            currentEditTab = 'basic';
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.modal-tab:first-child').classList.add('active');
            document.getElementById('tabBasic').classList.add('active');

            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingFlow = null;
            currentEditTab = 'basic';
        }

        // Handle edit form submission
        document.getElementById('editFlowForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!editingFlow) return;

            let updatedFlow;

            try {
                // If on advanced tab, parse JSON
                if (currentEditTab === 'advanced') {
                    const jsonText = document.getElementById('editFlowJSON').value;
                    updatedFlow = JSON.parse(jsonText);

                    // Validate flow structure
                    if (!updatedFlow.flow_id || !updatedFlow.device_id) {
                        throw new Error('Invalid flow JSON: missing flow_id or device_id');
                    }
                } else {
                    // Use basic form values
                    updatedFlow = {
                        ...editingFlow.flow,
                        name: document.getElementById('editFlowName').value,
                        description: document.getElementById('editFlowDescription').value,
                        update_interval_seconds: parseInt(document.getElementById('editFlowInterval').value),
                        enabled: document.getElementById('editFlowEnabled').checked
                    };
                }

                await window.flowManager.updateFlow(editingFlow.deviceId, editingFlow.flowId, updatedFlow);
                showToast('Flow updated successfully', 'success');
                closeEditModal();
                await loadFlows();
            } catch (error) {
                if (error instanceof SyntaxError) {
                    showToast('Invalid JSON: ' + error.message, 'error', 5000);
                } else {
                    showToast('Failed to update flow: ' + error.message, 'error', 5000);
                }
            }
        });

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });

        // Make functions globally available
        window.loadFlows = loadFlows;
        window.executeFlow = executeFlow;
        window.deleteFlow = deleteFlow;
        window.editFlow = editFlow;
        window.closeEditModal = closeEditModal;
        window.switchEditTab = switchEditTab;

        // Load flows on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadFlows);
        } else {
            loadFlows();
        }
    </script>
</body>
</html>
