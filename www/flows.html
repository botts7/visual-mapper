<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="0.0.5">
    <meta name="version" content="0.0.5" data-build="2025-12-27">
    <title>Flow Management - Visual Mapper</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css?v=0.0.5">
    <style>
        .flow-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .flow-header h1 {
            margin: 0;
            color: var(--text-color);
        }

        .flow-actions {
            display: flex;
            gap: 10px;
        }

        .flow-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-background);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .flow-table thead {
            background: #3b82f6;
            color: white;
        }

        .flow-table th,
        .flow-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .flow-table tbody tr:hover {
            background: var(--hover);
        }

        .flow-table tbody tr {
            background: var(--card-background);
        }

        .flow-table td code {
            color: var(--text-secondary);
        }

        .flow-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .flow-status.enabled {
            background: #22c55e;
            color: white;
        }

        .flow-status.disabled {
            background: #94a3b8;
            color: white;
        }

        .flow-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-color);
        }

        .flow-row-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--hover);
        }

        .btn-icon.execute {
            color: #3b82f6;
            border-color: #3b82f6;
            position: relative;
        }

        .btn-icon.execute:hover {
            background: #3b82f6;
            color: white;
        }

        .btn-icon.execute.running {
            background: #10b981;
            color: white;
            border-color: #10b981;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .flow-status.running {
            background: #10b981;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .btn-icon.delete {
            color: #ef4444;
            border-color: #ef4444;
        }

        .btn-icon.delete:hover {
            background: #ef4444;
            color: white;
        }

        .btn-icon.edit {
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .btn-icon.edit:hover {
            background: #f59e0b;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        /* Edit Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 10001;
            color: var(--text-color);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .modal-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .modal-tab:hover {
            color: var(--text-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px;
            min-height: 500px;
            height: 60vh;
            max-height: none;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            white-space: pre;
        }

        .json-editor-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Flow Steps UI Editor */
        .steps-editor {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .step-card {
            background: var(--preview-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .step-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .step-type-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .step-actions {
            display: flex;
            gap: 5px;
        }

        .step-action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
        }

        .step-action-btn:hover {
            background: var(--hover);
        }

        .step-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .step-field {
            display: flex;
            flex-direction: column;
        }

        .step-field label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .step-field input,
        .step-field select {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            background: var(--background-color);
            color: var(--text-color);
        }

        .add-step-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }

        .add-step-btn:hover {
            background: #2563eb;
        }

        /* Alerts Panel */
        .alerts-panel {
            background: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alerts-panel.hidden {
            display: none;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .alerts-header h3 {
            margin: 0;
            color: var(--text-color);
        }

        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .alert-card {
            background: var(--preview-background);
            border-left: 4px solid;
            padding: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .alert-card.severity-info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .alert-card.severity-warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .alert-card.severity-error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .alert-card.severity-critical {
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.15);
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .alert-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .alert-recommendations {
            list-style: none;
            padding: 0;
            margin: 8px 0 0 0;
        }

        .alert-recommendations li {
            padding: 4px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .alert-recommendations li:before {
            content: "‚Üí ";
            color: var(--text-secondary);
            margin-right: 5px;
        }

        .alert-dismiss {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 18px;
            line-height: 1;
        }

        .alert-dismiss:hover {
            color: var(--text-color);
        }

        /* Scheduler Dashboard */
        .scheduler-dashboard {
            background: var(--card-background, #fff);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .scheduler-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scheduler-header h3 {
            margin: 0;
            color: var(--text-color, #333);
        }

        .scheduler-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .scheduler-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .scheduler-status-badge.running {
            background: #dcfce7;
            color: #166534;
        }

        .scheduler-status-badge.paused {
            background: #fef3c7;
            color: #92400e;
        }

        .scheduler-status-badge.stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        .status-dot.running {
            background: #22c55e;
        }

        .status-dot.paused {
            background: #f59e0b;
            animation: none;
        }

        .status-dot.stopped {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .device-queue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .device-queue-card {
            background: var(--background-color, #f8fafc);
            border: 1px solid var(--border-color, #e2e8f0);
            border-radius: 8px;
            padding: 15px;
        }

        .device-queue-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--text-color, #333);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-queue-card .queue-stats {
            display: flex;
            gap: 15px;
        }

        .queue-stat {
            display: flex;
            flex-direction: column;
        }

        .queue-stat-label {
            font-size: 11px;
            color: var(--text-secondary, #64748b);
            text-transform: uppercase;
        }

        .queue-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-color, #333);
        }

        .queue-stat-value.warning {
            color: #f59e0b;
        }

        .queue-stat-value.critical {
            color: #ef4444;
        }

        .btn-pause {
            background: #f59e0b;
            color: white;
        }

        .btn-pause:hover {
            background: #d97706;
        }

        .btn-resume {
            background: #22c55e;
            color: white;
        }

        .btn-resume:hover {
            background: #16a34a;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <!-- High priority - always visible -->
            <li class="nav-priority-high"><a href="main.html">Dashboard</a></li>
            <li class="nav-priority-high"><a href="devices.html">Devices</a></li>
            <li class="nav-priority-high"><a href="sensors.html">Sensors</a></li>

            <!-- Medium priority - hidden on mobile -->
            <li class="nav-priority-med"><a href="actions.html">Actions</a></li>
            <li class="nav-priority-med"><a href="flows.html" class="active">Flows</a></li>
            <li class="nav-priority-med"><a href="diagnostic.html">Diagnostics</a></li>

            <!-- Low priority - hidden on tablet -->
            <li class="nav-priority-low"><a href="dev.html">Dev Tools</a></li>

            <li class="version">v0.0.5</li>
            <li class="nav-logo"><img src="favicon.svg" alt="Visual Mapper"></li>
            <li id="themeToggleContainer"></li>
        </ul>
    </nav>

    <div class="flow-container">
        <div class="flow-header">
            <h1>Flow Management</h1>
            <div class="flow-actions">
                <button class="btn btn-primary" onclick="window.location.href='flow-wizard.html'">
                    ‚ú® Create Flow Wizard
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='create-flow.html'">
                    Advanced
                </button>
                <button class="btn btn-secondary" onclick="loadFlows()">
                    Refresh
                </button>
            </div>
        </div>

        <div class="flow-stats" id="flowStats">
            <div class="stat-card">
                <h3>Total Flows</h3>
                <div class="value" id="statTotal">0</div>
            </div>
            <div class="stat-card">
                <h3>Enabled</h3>
                <div class="value" id="statEnabled">0</div>
            </div>
            <div class="stat-card">
                <h3>Queue Depth</h3>
                <div class="value" id="statQueueDepth">0</div>
            </div>
            <div class="stat-card">
                <h3>Success Rate</h3>
                <div class="value" id="statSuccessRate">-</div>
            </div>
        </div>

        <!-- Scheduler Dashboard -->
        <div class="scheduler-dashboard" id="schedulerDashboard">
            <div class="scheduler-header">
                <h3>Scheduler Status</h3>
                <div class="scheduler-controls">
                    <span class="scheduler-status-badge running" id="schedulerStatusBadge">
                        <span class="status-dot running" id="schedulerStatusDot"></span>
                        <span id="schedulerStatusText">Running</span>
                    </span>
                    <button class="btn btn-pause" id="btnPauseScheduler" onclick="pauseScheduler()">
                        Pause All
                    </button>
                    <button class="btn btn-resume" id="btnResumeScheduler" onclick="resumeScheduler()" style="display: none;">
                        Resume
                    </button>
                </div>
            </div>
            <div id="deviceQueues" class="device-queue-grid">
                <!-- Device queue cards will be populated here -->
                <p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">
                    Loading scheduler status...
                </p>
            </div>
        </div>

        <!-- Alerts Panel -->
        <div id="alertsPanel" class="alerts-panel hidden">
            <div class="alerts-header">
                <h3>Performance Alerts</h3>
                <button type="button" class="btn btn-sm" onclick="clearAllAlerts()">Clear All</button>
            </div>
            <div id="alertsList" class="alerts-list"></div>
        </div>

        <div id="flowTableContainer">
            <table class="flow-table" id="flowTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>App(s)</th>
                        <th>Device</th>
                        <th>IP</th>
                        <th>Steps</th>
                        <th>Interval</th>
                        <th>Enabled</th>
                        <th>Status</th>
                        <th>Last Run</th>
                        <th>Success</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="flowTableBody">
                    <tr>
                        <td colspan="11" class="empty-state">
                            Loading flows...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Flow Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Flow</h2>
            </div>

            <!-- Tabs -->
            <div class="modal-tabs">
                <button type="button" class="modal-tab active" onclick="switchEditTab('basic')">Basic Settings</button>
                <button type="button" class="modal-tab" onclick="switchEditTab('steps')">Flow Steps</button>
                <button type="button" class="modal-tab" onclick="switchEditTab('advanced')">Advanced (JSON)</button>
            </div>

            <form id="editFlowForm">
                <!-- Basic Settings Tab -->
                <div id="tabBasic" class="tab-content active">
                    <div class="form-group">
                        <label for="editFlowName">Flow Name *</label>
                        <input type="text" id="editFlowName" required>
                    </div>
                    <div class="form-group">
                        <label for="editFlowDescription">Description</label>
                        <textarea id="editFlowDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFlowInterval">Update Interval (seconds)</label>
                        <input type="number" id="editFlowInterval" min="5" required>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="editFlowEnabled">
                            <label for="editFlowEnabled" style="margin: 0">Flow Enabled</label>
                        </div>
                    </div>
                </div>

                <!-- Flow Steps Tab -->
                <div id="tabSteps" class="tab-content">
                    <div id="stepsEditor" class="steps-editor">
                        <!-- Steps will be dynamically rendered here -->
                    </div>
                    <div class="add-step-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button type="button" class="add-step-btn" onclick="addNewStep()">+ Add Step</button>
                        <button type="button" class="add-step-btn" style="background: #4CAF50;" onclick="showInsertSensorDialog()">üìä Insert Sensor</button>
                        <button type="button" class="add-step-btn" style="background: #2196F3;" onclick="showInsertActionDialog()">‚ö° Insert Action</button>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="tabAdvanced" class="tab-content">
                    <div class="json-editor-warning">
                        ‚ö†Ô∏è <strong>Advanced Mode:</strong> Edit flow JSON directly. Changes must be valid JSON or save will fail.
                    </div>
                    <div class="form-group">
                        <label for="editFlowJSON">Flow JSON</label>
                        <textarea id="editFlowJSON" class="json-editor"></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="testCurrentFlow()" style="background: #2196F3; color: white;">
                        üß™ Test Flow
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Execution Results Modal -->
    <div class="modal-overlay" id="executionResultsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Flow Execution Results</h2>
            </div>
            <div id="executionResultsContent" class="modal-body" style="min-height: 150px;">
                <!-- Results will be dynamically inserted here -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeExecutionResultsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import FlowManager from './js/modules/flow-manager.js?v=0.0.5';
        import { showToast } from './js/modules/toast.js?v=0.0.5';
        import ThemeToggle from './js/modules/theme-toggle.js?v=0.0.5';
        import MobileNav from './js/modules/mobile-nav.js?v=0.0.5';

        // Initialize theme and mobile nav
        const themeToggle = new ThemeToggle();
        const mobileNav = new MobileNav();
        themeToggle.apply();
        mobileNav.init();
        const themeToggleContainer = document.getElementById('themeToggleContainer');
        if (themeToggleContainer) {
            themeToggleContainer.appendChild(themeToggle.createToggleButton());
        }

        // Make functions globally available
        window.flowManager = new FlowManager();
        window.showToast = showToast;

        let flows = [];
        const runningFlows = new Set(); // Track currently executing flows
        const deviceInfoMap = new Map(); // Map device_id to device info (model, etc.)

        async function loadDeviceInfo() {
            try {
                const response = await fetch(`${window.flowManager.apiBase}/adb/devices`);
                if (!response.ok) throw new Error('Failed to fetch devices');
                const data = await response.json();
                const devices = data.devices || [];

                deviceInfoMap.clear();
                devices.forEach(device => {
                    deviceInfoMap.set(device.id, device);
                });
                console.log(`[Flows] Loaded info for ${devices.length} devices`);
            } catch (error) {
                console.warn('[Flows] Could not load device info:', error);
            }
        }

        async function loadFlows() {
            try {
                // Load device info first (for device names)
                await loadDeviceInfo();
                flows = await window.flowManager.getFlows();
                renderFlowTable();
                updateStats();
                await loadAlerts(); // Load alerts after flows
                await loadSchedulerStatus(); // Load scheduler status
            } catch (error) {
                console.error('Failed to load flows:', error);
                showToast('Failed to load flows: ' + error.message, 'error');
            }
        }

        async function loadSchedulerStatus() {
            try {
                const response = await fetch(`${window.flowManager.apiBase}/scheduler/status`);
                if (!response.ok) throw new Error('Failed to fetch scheduler status');

                const data = await response.json();
                const status = data.status;

                renderSchedulerStatus(status);
            } catch (error) {
                console.error('Failed to load scheduler status:', error);
                document.getElementById('deviceQueues').innerHTML = `
                    <p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">
                        Unable to load scheduler status
                    </p>
                `;
            }
        }

        function renderSchedulerStatus(status) {
            const statusBadge = document.getElementById('schedulerStatusBadge');
            const statusDot = document.getElementById('schedulerStatusDot');
            const statusText = document.getElementById('schedulerStatusText');
            const pauseBtn = document.getElementById('btnPauseScheduler');
            const resumeBtn = document.getElementById('btnResumeScheduler');
            const deviceQueues = document.getElementById('deviceQueues');

            // Update status badge
            let state = 'stopped';
            if (status.running && !status.paused) {
                state = 'running';
                statusText.textContent = 'Running';
            } else if (status.paused) {
                state = 'paused';
                statusText.textContent = 'Paused';
            } else {
                statusText.textContent = 'Stopped';
            }

            statusBadge.className = `scheduler-status-badge ${state}`;
            statusDot.className = `status-dot ${state}`;

            // Toggle buttons
            if (status.paused) {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block';
            } else {
                pauseBtn.style.display = 'inline-block';
                resumeBtn.style.display = 'none';
            }

            // Render device queue cards
            const devices = status.devices || {};
            const deviceIds = Object.keys(devices);

            if (deviceIds.length === 0) {
                deviceQueues.innerHTML = `
                    <p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">
                        No devices with active schedulers
                    </p>
                `;
                return;
            }

            deviceQueues.innerHTML = deviceIds.map(deviceId => {
                const device = devices[deviceId];
                const queueDepth = device.queue_depth || 0;
                const queueClass = queueDepth > 5 ? 'critical' : (queueDepth > 2 ? 'warning' : '');

                return `
                    <div class="device-queue-card">
                        <h4>
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${device.scheduler_active ? '#22c55e' : '#94a3b8'};"></span>
                            ${escapeHtml(deviceId)}
                        </h4>
                        <div class="queue-stats">
                            <div class="queue-stat">
                                <span class="queue-stat-label">Queue</span>
                                <span class="queue-stat-value ${queueClass}">${queueDepth}</span>
                            </div>
                            <div class="queue-stat">
                                <span class="queue-stat-label">Total Runs</span>
                                <span class="queue-stat-value">${device.total_executions || 0}</span>
                            </div>
                            <div class="queue-stat">
                                <span class="queue-stat-label">Last Run</span>
                                <span class="queue-stat-value" style="font-size: 12px;">
                                    ${device.last_execution ? formatTimeAgo(device.last_execution) : 'Never'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTimeAgo(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);

            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHour < 24) return `${diffHour}h ago`;
            return date.toLocaleDateString();
        }

        async function pauseScheduler() {
            try {
                const response = await fetch(`${window.flowManager.apiBase}/scheduler/pause`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to pause scheduler');

                showToast('Scheduler paused', 'success');
                await loadSchedulerStatus();
            } catch (error) {
                showToast('Failed to pause scheduler: ' + error.message, 'error');
            }
        }

        async function resumeScheduler() {
            try {
                const response = await fetch(`${window.flowManager.apiBase}/scheduler/resume`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to resume scheduler');

                showToast('Scheduler resumed', 'success');
                await loadSchedulerStatus();
            } catch (error) {
                showToast('Failed to resume scheduler: ' + error.message, 'error');
            }
        }

        async function loadAlerts() {
            try {
                const response = await fetch(`${window.flowManager.apiBase}/flows/alerts?limit=10`);
                if (!response.ok) throw new Error('Failed to fetch alerts');

                const data = await response.json();
                const alerts = data.alerts || [];

                renderAlerts(alerts);
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        function renderAlerts(alerts) {
            const alertsPanel = document.getElementById('alertsPanel');
            const alertsList = document.getElementById('alertsList');

            if (alerts.length === 0) {
                alertsPanel.classList.add('hidden');
                return;
            }

            alertsPanel.classList.remove('hidden');

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-card severity-${alert.severity}">
                    <div class="alert-content">
                        <div class="alert-message">
                            ${getSeverityIcon(alert.severity)} ${escapeHtml(alert.message)}
                        </div>
                        <div class="alert-timestamp">
                            ${formatDateTime(alert.timestamp)}
                            ${alert.device_id ? ` ‚Ä¢ Device: ${alert.device_id}` : ''}
                            ${alert.flow_id ? ` ‚Ä¢ Flow: ${alert.flow_id}` : ''}
                        </div>
                        ${alert.recommendations && alert.recommendations.length > 0 ? `
                            <ul class="alert-recommendations">
                                ${alert.recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                    <button type="button" class="alert-dismiss" onclick="dismissAlert('${alert.device_id}', event)" title="Dismiss alert">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        function getSeverityIcon(severity) {
            const icons = {
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è',
                error: '‚ùå',
                critical: 'üö®'
            };
            return icons[severity] || '‚ÑπÔ∏è';
        }

        async function clearAllAlerts() {
            if (!confirm('Clear all performance alerts?')) {
                return;
            }

            try {
                const response = await fetch(`${window.flowManager.apiBase}/flows/alerts`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to clear alerts');

                showToast('Alerts cleared', 'success');
                await loadAlerts();
            } catch (error) {
                showToast('Failed to clear alerts: ' + error.message, 'error');
            }
        }

        async function dismissAlert(deviceId, event) {
            event.stopPropagation();

            try {
                const url = deviceId
                    ? `${window.flowManager.apiBase}/flows/alerts?device_id=${encodeURIComponent(deviceId)}`
                    : `${window.flowManager.apiBase}/flows/alerts`;

                const response = await fetch(url, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to dismiss alert');

                await loadAlerts();
            } catch (error) {
                showToast('Failed to dismiss alert: ' + error.message, 'error');
            }
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flowTableBody');

            if (flows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <p>No flows configured yet.</p>
                            <p>Flows will appear here once you create them via the API.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = flows.map(flow => {
                const flowKey = `${flow.device_id}:${flow.flow_id}`;
                const isRunning = runningFlows.has(flowKey);

                // Extract apps from launch_app steps
                const apps = getFlowApps(flow);
                const appsDisplay = apps.length > 0 ? apps.join(', ') : '-';

                // Parse device ID into name and IP
                const { deviceName, deviceIP } = parseDeviceId(flow.device_id);

                return `
                <tr>
                    <td><strong>${escapeHtml(flow.name)}</strong></td>
                    <td><code style="font-size: 11px;">${escapeHtml(appsDisplay)}</code></td>
                    <td>${escapeHtml(deviceName)}</td>
                    <td><code>${escapeHtml(deviceIP)}</code></td>
                    <td>${flow.steps.length} steps</td>
                    <td>${flow.update_interval_seconds}s</td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   ${flow.enabled ? 'checked' : ''}
                                   onchange="toggleFlowEnabled('${flow.device_id}', '${flow.flow_id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>
                        <span class="flow-status ${isRunning ? 'running' : (flow.enabled ? 'enabled' : 'disabled')}">
                            ${isRunning ? '‚ñ∂ Running' : (flow.enabled ? 'Enabled' : 'Disabled')}
                        </span>
                    </td>
                    <td>${formatDateTime(flow.last_executed)}</td>
                    <td>${formatSuccessRate(flow)}</td>
                    <td>
                        <div class="flow-row-actions">
                            <button class="btn-icon execute ${isRunning ? 'running' : ''}"
                                    data-device-id="${flow.device_id}"
                                    data-flow-id="${flow.flow_id}"
                                    onclick="executeFlow('${flow.device_id}', '${flow.flow_id}')"
                                    title="Execute Now"
                                    ${isRunning ? 'disabled' : ''}>
                                ${isRunning ? '‚è≥' : '‚ñ∂'}
                            </button>
                            <button class="btn-icon test"
                                    onclick="testFlow('${flow.device_id}', '${flow.flow_id}')"
                                    title="Test Flow"
                                    ${isRunning ? 'disabled' : ''}>
                                üß™
                            </button>
                            <button class="btn-icon edit"
                                    onclick="editFlow('${flow.device_id}', '${flow.flow_id}')"
                                    title="Edit">
                                ‚úè
                            </button>
                            <button class="btn-icon delete"
                                    onclick="deleteFlow('${flow.device_id}', '${flow.flow_id}', '${escapeHtml(flow.name)}')"
                                    title="Delete">
                                ‚úï
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function updateStats() {
            const totalFlows = flows.length;
            const enabledFlows = flows.filter(f => f.enabled).length;

            document.getElementById('statTotal').textContent = totalFlows;
            document.getElementById('statEnabled').textContent = enabledFlows;

            // Get metrics for queue depth and success rate
            try {
                const metricsData = await window.flowManager.getMetrics();
                const metrics = metricsData.all_devices || {};

                let totalQueueDepth = 0;
                let totalSuccessRate = 0;
                let deviceCount = 0;

                Object.values(metrics).forEach(m => {
                    if (m.queue_depth !== undefined) {
                        totalQueueDepth += m.queue_depth;
                        deviceCount++;
                    }
                    if (m.success_rate !== undefined) {
                        totalSuccessRate += m.success_rate;
                    }
                });

                document.getElementById('statQueueDepth').textContent = totalQueueDepth;

                if (deviceCount > 0) {
                    const avgSuccessRate = (totalSuccessRate / deviceCount) * 100;
                    document.getElementById('statSuccessRate').textContent =
                        avgSuccessRate.toFixed(1) + '%';
                } else {
                    document.getElementById('statSuccessRate').textContent = '-';
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        async function executeFlow(deviceId, flowId) {
            const flowKey = `${deviceId}:${flowId}`;

            // Prevent double-execution
            if (runningFlows.has(flowKey)) {
                showToast('Flow is already running', 'warning');
                return;
            }

            try {
                // Add to running set and update UI
                runningFlows.add(flowKey);
                renderFlowTable(); // Re-render to show running state

                showToast('Flow execution started...', 'info');

                // Execute the flow via API and get execution result
                const response = await fetch(`${window.flowManager.apiBase}/flows/${deviceId}/${flowId}/execute`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Flow execution failed');
                }

                const result = await response.json();
                console.log('[Flows] Flow execution result:', result);

                // Show execution results
                showExecutionResults(result);

                showToast('Flow execution completed!', 'success');

                // Keep running state visible for 2 seconds, then refresh
                setTimeout(async () => {
                    runningFlows.delete(flowKey);
                    await loadFlows(); // Reload to get updated stats
                }, 2000);

            } catch (error) {
                // Remove from running set on error
                runningFlows.delete(flowKey);
                renderFlowTable(); // Re-render to remove running state
                showToast('Failed to execute flow: ' + error.message, 'error');
            }
        }

        /**
         * Show execution results in modal
         */
        function showExecutionResults(result) {
            const modal = document.getElementById('executionResultsModal');
            const content = document.getElementById('executionResultsContent');

            // Get flow steps count from result or flows array
            const flow = flows.find(f => f.flow_id === result.flow_id);
            const totalSteps = flow ? flow.steps.length : result.executed_steps ?? 0;

            // Display results based on success/failure
            if (result.success) {
                const executedSteps = result.executed_steps ?? 0;
                const executionTime = result.execution_time_ms ?? 0;
                const capturedSensors = result.captured_sensors || {};

                content.innerHTML = `
                    <div class="test-success">
                        <h4>‚úÖ Flow Execution Successful</h4>
                        <p><strong>Executed Steps:</strong> ${executedSteps} / ${totalSteps}</p>
                        <p><strong>Execution Time:</strong> ${executionTime}ms</p>
                        ${Object.keys(capturedSensors).length > 0 ? `
                            <div class="captured-sensors">
                                <strong>Captured Sensors:</strong>
                                <ul>
                                    ${Object.entries(capturedSensors).map(([id, value]) =>
                                        `<li><strong>${escapeHtml(id)}:</strong> ${escapeHtml(String(value))}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                const executedSteps = result.executed_steps ?? 0;
                const failedStep = result.failed_step !== null && result.failed_step !== undefined ? result.failed_step + 1 : 'Unknown';

                content.innerHTML = `
                    <div class="test-failure">
                        <h4>‚ùå Flow Execution Failed</h4>
                        <p><strong>Failed at Step:</strong> ${failedStep}</p>
                        <p><strong>Error:</strong> ${escapeHtml(result.error_message || 'Unknown error')}</p>
                        <p><strong>Executed Steps:</strong> ${executedSteps} / ${totalSteps}</p>
                    </div>
                `;
            }

            // Show modal
            modal.classList.add('active');
        }

        /**
         * Close execution results modal
         */
        function closeExecutionResultsModal() {
            const modal = document.getElementById('executionResultsModal');
            modal.classList.remove('active');
        }

        /**
         * Test a flow from the flow table
         */
        async function testFlow(deviceId, flowId) {
            try {
                showToast('Testing flow...', 'info');

                // Execute the flow via API
                const response = await fetch(`${window.flowManager.apiBase}/flows/${deviceId}/${flowId}/execute`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Flow test failed');
                }

                const result = await response.json();
                console.log('[Flows] Flow test result:', result);

                // Show execution results
                showExecutionResults(result);

                if (result.success) {
                    showToast('Flow test passed!', 'success');
                } else {
                    showToast('Flow test failed', 'error');
                }

            } catch (error) {
                console.error('[Flows] Flow test error:', error);
                showToast(`Test error: ${error.message}`, 'error');
            }
        }

        /**
         * Test the currently edited flow (from edit modal)
         */
        async function testCurrentFlow() {
            if (!editingFlow) {
                showToast('No flow is being edited', 'error');
                return;
            }

            try {
                showToast('Testing flow...', 'info');

                const { deviceId, flowId } = editingFlow;

                // Get the current flow data from the form (in case user made changes)
                // We'll test the saved version, not the in-progress edits
                const response = await fetch(`${window.flowManager.apiBase}/flows/${deviceId}/${flowId}/execute`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Flow test failed');
                }

                const result = await response.json();
                console.log('[Flows] Flow test result:', result);

                // Show execution results
                showExecutionResults(result);

                if (result.success) {
                    showToast('Flow test passed!', 'success');
                } else {
                    showToast('Flow test failed', 'error');
                }

            } catch (error) {
                console.error('[Flows] Flow test error:', error);
                showToast(`Test error: ${error.message}`, 'error');
            }
        }

        async function deleteFlow(deviceId, flowId, flowName) {
            if (!confirm(`Are you sure you want to delete flow "${flowName}"?`)) {
                return;
            }

            try {
                await window.flowManager.deleteFlow(deviceId, flowId);
                showToast('Flow deleted successfully', 'success');
                await loadFlows();
            } catch (error) {
                showToast('Failed to delete flow: ' + error.message, 'error');
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        function formatSuccessRate(flow) {
            if (flow.execution_count === 0) return '-';
            const rate = (flow.success_count / flow.execution_count) * 100;
            return `${flow.success_count}/${flow.execution_count} (${rate.toFixed(0)}%)`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Extract app package names from flow steps
         */
        function getFlowApps(flow) {
            const apps = new Set();
            for (const step of flow.steps || []) {
                if (step.step_type === 'launch_app' && step.package) {
                    // Get the short app name (last part of package)
                    const parts = step.package.split('.');
                    const shortName = parts[parts.length - 1] || step.package;
                    apps.add(shortName);
                }
            }
            return Array.from(apps);
        }

        /**
         * Parse device ID into device name and IP address
         * Format: IP:PORT or just device name
         */
        function parseDeviceId(deviceId) {
            if (!deviceId) {
                return { deviceName: '-', deviceIP: '-' };
            }

            // Try to get device info from the map
            const deviceInfo = deviceInfoMap.get(deviceId);

            // Check if it looks like IP:PORT format
            const ipPortMatch = deviceId.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):?(\d+)?$/);
            if (ipPortMatch) {
                const ip = ipPortMatch[1];
                const port = ipPortMatch[2] || '5555';
                // Use device model if available, otherwise IP
                return {
                    deviceName: deviceInfo?.model || ip,
                    deviceIP: `${ip}:${port}`
                };
            }

            // If it's not IP format, treat the whole thing as device name
            return {
                deviceName: deviceInfo?.model || deviceId,
                deviceIP: '-'
            };
        }

        let editingFlow = null;
        let currentEditTab = 'basic';

        function switchEditTab(tabName) {
            currentEditTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'basic') {
                document.getElementById('tabBasic').classList.add('active');
                syncBasicFormFromJSON();
            } else if (tabName === 'steps') {
                document.getElementById('tabSteps').classList.add('active');
                renderFlowSteps();
            } else if (tabName === 'advanced') {
                document.getElementById('tabAdvanced').classList.add('active');
                syncJSONFromBasicForm();
            }
        }

        async function toggleFlowEnabled(deviceId, flowId, enabled) {
            try {
                const flow = flows.find(f => f.device_id === deviceId && f.flow_id === flowId);
                if (!flow) return;

                // Update flow with new enabled status
                const updatedFlow = { ...flow, enabled };
                await window.flowManager.updateFlow(deviceId, flowId, updatedFlow);

                showToast(`Flow ${enabled ? 'enabled' : 'disabled'}`, 'success');
                await loadFlows(); // Reload to update UI
            } catch (error) {
                showToast(`Failed to toggle flow: ${error.message}`, 'error');
                // Reload to revert checkbox state
                await loadFlows();
            }
        }

        function renderFlowSteps() {
            if (!editingFlow) return;

            const stepsContainer = document.getElementById('stepsEditor');
            const steps = editingFlow.flow.steps || [];

            if (steps.length === 0) {
                stepsContainer.innerHTML = '<p style="text-align:center;color:#64748b;">No steps defined yet. Click "+ Add Step" to create one.</p>';
                return;
            }

            stepsContainer.innerHTML = steps.map((step, index) => `
                <div class="step-card" data-step-index="${index}">
                    <div class="step-card-header">
                        <span class="step-type-badge">${step.step_type || 'unknown'}</span>
                        <div class="step-actions">
                            <button type="button" class="step-action-btn" onclick="moveStepUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                            <button type="button" class="step-action-btn" onclick="moveStepDown(${index})" ${index === steps.length - 1 ? 'disabled' : ''}>‚Üì</button>
                            <button type="button" class="step-action-btn" onclick="deleteStep(${index})">‚úï</button>
                        </div>
                    </div>
                    <div class="step-fields">
                        ${renderStepFields(step, index)}
                    </div>
                </div>
            `).join('');
        }

        function renderStepFields(step, index) {
            const stepType = step.step_type;
            let fields = `
                <div class="step-field" style="grid-column: 1 / -1">
                    <label>Description</label>
                    <input type="text" value="${escapeHtml(step.description || '')}"
                           onchange="updateStepField(${index}, 'description', this.value)">
                </div>
            `;

            // Type-specific fields
            if (stepType === 'tap') {
                fields += `
                    <div class="step-field">
                        <label>X Coordinate</label>
                        <input type="number" value="${step.x || ''}"
                               onchange="updateStepField(${index}, 'x', parseInt(this.value))">
                    </div>
                    <div class="step-field">
                        <label>Y Coordinate</label>
                        <input type="number" value="${step.y || ''}"
                               onchange="updateStepField(${index}, 'y', parseInt(this.value))">
                    </div>
                `;
            } else if (stepType === 'swipe') {
                fields += `
                    <div class="step-field">
                        <label>Start X</label>
                        <input type="number" value="${step.start_x || ''}"
                               onchange="updateStepField(${index}, 'start_x', parseInt(this.value))">
                    </div>
                    <div class="step-field">
                        <label>Start Y</label>
                        <input type="number" value="${step.start_y || ''}"
                               onchange="updateStepField(${index}, 'start_y', parseInt(this.value))">
                    </div>
                    <div class="step-field">
                        <label>End X</label>
                        <input type="number" value="${step.end_x || ''}"
                               onchange="updateStepField(${index}, 'end_x', parseInt(this.value))">
                    </div>
                    <div class="step-field">
                        <label>End Y</label>
                        <input type="number" value="${step.end_y || ''}"
                               onchange="updateStepField(${index}, 'end_y', parseInt(this.value))">
                    </div>
                    <div class="step-field">
                        <label>Duration (ms)</label>
                        <input type="number" value="${step.duration || 500}"
                               onchange="updateStepField(${index}, 'duration', parseInt(this.value))">
                    </div>
                `;
            } else if (stepType === 'type_text') {
                fields += `
                    <div class="step-field" style="grid-column: 1 / -1">
                        <label>Text to Type</label>
                        <input type="text" value="${escapeHtml(step.text || '')}"
                               onchange="updateStepField(${index}, 'text', this.value)">
                    </div>
                `;
            } else if (stepType === 'wait') {
                fields += `
                    <div class="step-field">
                        <label>Duration (seconds)</label>
                        <input type="number" step="0.1" value="${step.duration || 1}"
                               onchange="updateStepField(${index}, 'duration', parseFloat(this.value))">
                    </div>
                `;
            } else if (stepType === 'launch_app') {
                fields += `
                    <div class="step-field" style="grid-column: 1 / -1">
                        <label>Package Name</label>
                        <input type="text" value="${escapeHtml(step.package || '')}"
                               onchange="updateStepField(${index}, 'package', this.value)">
                    </div>
                `;
            } else if (stepType === 'capture_sensors') {
                fields += `
                    <div class="step-field" style="grid-column: 1 / -1">
                        <label>Sensor IDs (comma-separated)</label>
                        <input type="text" value="${(step.sensor_ids || []).join(', ')}"
                               onchange="updateStepField(${index}, 'sensor_ids', this.value.split(',').map(s => s.trim()).filter(s => s))">
                    </div>
                `;
            }

            return fields;
        }

        function updateStepField(stepIndex, field, value) {
            if (!editingFlow) return;
            editingFlow.flow.steps[stepIndex][field] = value;
        }

        function deleteStep(stepIndex) {
            if (!editingFlow) return;
            if (!confirm('Delete this step?')) return;

            editingFlow.flow.steps.splice(stepIndex, 1);
            renderFlowSteps();
        }

        function moveStepUp(stepIndex) {
            if (!editingFlow || stepIndex === 0) return;
            const steps = editingFlow.flow.steps;
            [steps[stepIndex - 1], steps[stepIndex]] = [steps[stepIndex], steps[stepIndex - 1]];
            renderFlowSteps();
        }

        function moveStepDown(stepIndex) {
            if (!editingFlow) return;
            const steps = editingFlow.flow.steps;
            if (stepIndex === steps.length - 1) return;
            [steps[stepIndex], steps[stepIndex + 1]] = [steps[stepIndex + 1], steps[stepIndex]];
            renderFlowSteps();
        }

        function addNewStep() {
            if (!editingFlow) return;

            const stepType = prompt('Enter step type (tap, swipe, type_text, wait, launch_app, capture_sensors, keypress):');
            if (!stepType) return;

            const newStep = {
                step_type: stepType,
                description: `New ${stepType} step`,
                retry_on_failure: false,
                max_retries: 3
            };

            // Initialize type-specific fields
            if (stepType === 'tap') {
                newStep.x = 0;
                newStep.y = 0;
            } else if (stepType === 'swipe') {
                newStep.start_x = 0;
                newStep.start_y = 0;
                newStep.end_x = 0;
                newStep.end_y = 0;
                newStep.duration = 500;
            } else if (stepType === 'type_text') {
                newStep.text = '';
            } else if (stepType === 'wait') {
                newStep.duration = 1;
            } else if (stepType === 'launch_app') {
                newStep.package = '';
            } else if (stepType === 'capture_sensors') {
                newStep.sensor_ids = [];
            }

            editingFlow.flow.steps.push(newStep);
            renderFlowSteps();
        }

        async function showInsertSensorDialog() {
            if (!editingFlow) return;

            try {
                // Fetch existing sensors for this device
                const response = await fetch(`/api/sensors/${encodeURIComponent(editingFlow.deviceId)}`);
                const data = await response.json();
                const sensors = data.sensors || [];

                if (sensors.length === 0) {
                    showToast('No sensors found for this device', 'warning');
                    return;
                }

                // Create dialog overlay
                const overlay = document.createElement('div');
                overlay.id = 'insert-sensor-overlay';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0, 0, 0, 0.7); z-index: 10001;
                    display: flex; align-items: center; justify-content: center;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--card-background, #1e1e1e); border-radius: 8px;
                    padding: 20px; max-width: 500px; width: 90%; max-height: 70vh;
                    overflow-y: auto; color: var(--text-color, #e0e0e0);
                `;

                dialog.innerHTML = `
                    <h3 style="margin: 0 0 15px 0;">üìä Insert Existing Sensor</h3>
                    <p style="margin-bottom: 15px; color: #888; font-size: 0.9em;">
                        Select a sensor to add to this flow. Smart detection will find the element at runtime.
                    </p>
                    <div id="sensorList" style="max-height: 400px; overflow-y: auto;">
                        ${sensors.map(s => {
                            const resourceId = s.source?.element_resource_id ? s.source.element_resource_id.split('/').pop() : null;
                            const elementText = s.source?.element_text || null;
                            // Extract app name from resource_id (e.g., "com.byd.bydautolink:id/tem_tv" -> "bydautolink")
                            const appPackage = s.source?.element_resource_id ? s.source.element_resource_id.split(':')[0].split('.').pop() : null;
                            const extractionMethod = s.extraction_rule?.method || 'exact';
                            const deviceClass = s.device_class && s.device_class !== 'none' ? s.device_class : null;
                            const currentValue = s.current_value;
                            const unit = s.unit_of_measurement || '';
                            const lastUpdated = s.updated_at ? new Date(s.updated_at).toLocaleString() : null;

                            return `
                            <div class="sensor-option" data-sensor-id="${s.sensor_id}" data-sensor-name="${s.friendly_name}" style="
                                padding: 12px; margin: 5px 0; background: rgba(255,255,255,0.05);
                                border-radius: 6px; cursor: pointer; border: 2px solid transparent;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; font-size: 1.05em;">${s.friendly_name}</span>
                                    ${currentValue !== null && currentValue !== undefined ?
                                        '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: 600;">' + currentValue + unit + '</span>' :
                                        '<span style="background: #666; color: #ccc; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">No value</span>'
                                    }
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px;">
                                    ${appPackage ? '<span style="background: rgba(33,150,243,0.2); color: #64B5F6; padding: 2px 6px; border-radius: 4px; font-size: 0.75em;">üì± ' + appPackage + '</span>' : ''}
                                    ${deviceClass ? '<span style="background: rgba(156,39,176,0.2); color: #CE93D8; padding: 2px 6px; border-radius: 4px; font-size: 0.75em;">üìä ' + deviceClass + '</span>' : ''}
                                    ${extractionMethod ? '<span style="background: rgba(255,152,0,0.2); color: #FFB74D; padding: 2px 6px; border-radius: 4px; font-size: 0.75em;">üîß ' + extractionMethod + '</span>' : ''}
                                </div>
                                <div style="font-size: 0.8em; color: #888; margin-top: 6px;">
                                    ${resourceId ? '<div>üÜî <code style="background: rgba(0,0,0,0.3); padding: 1px 4px; border-radius: 3px;">' + resourceId + '</code></div>' : ''}
                                    ${elementText ? '<div style="margin-top: 2px;">üìù "' + (elementText.length > 40 ? elementText.substring(0, 40) + '...' : elementText) + '"</div>' : ''}
                                </div>
                                ${lastUpdated ? '<div style="font-size: 0.7em; color: #666; margin-top: 4px;">‚è±Ô∏è Last: ' + lastUpdated + '</div>' : ''}
                            </div>
                        `;}).join('')}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                // Handle sensor selection
                dialog.querySelectorAll('.sensor-option').forEach(option => {
                    option.addEventListener('mouseover', () => option.style.borderColor = '#4CAF50');
                    option.addEventListener('mouseout', () => option.style.borderColor = 'transparent');
                    option.addEventListener('click', () => {
                        const sensorId = option.dataset.sensorId;
                        const sensorName = option.dataset.sensorName;

                        // Add capture_sensors step
                        editingFlow.flow.steps.push({
                            step_type: 'capture_sensors',
                            sensor_ids: [sensorId],
                            description: `Capture: ${sensorName}`
                        });

                        renderFlowSteps();
                        document.body.removeChild(overlay);
                        showToast(`Added sensor: ${sensorName}`, 'success');
                    });
                });

                dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) document.body.removeChild(overlay);
                });

            } catch (error) {
                console.error('Failed to load sensors:', error);
                showToast('Failed to load sensors', 'error');
            }
        }

        async function showInsertActionDialog() {
            if (!editingFlow) return;

            try {
                // Fetch existing actions for this device
                const response = await fetch(`/api/actions/${encodeURIComponent(editingFlow.deviceId)}`);
                const data = await response.json();
                const actions = data.actions || [];

                if (actions.length === 0) {
                    showToast('No actions found for this device', 'warning');
                    return;
                }

                // Create dialog overlay
                const overlay = document.createElement('div');
                overlay.id = 'insert-action-overlay';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0, 0, 0, 0.7); z-index: 10001;
                    display: flex; align-items: center; justify-content: center;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--card-background, #1e1e1e); border-radius: 8px;
                    padding: 20px; max-width: 500px; width: 90%; max-height: 70vh;
                    overflow-y: auto; color: var(--text-color, #e0e0e0);
                `;

                dialog.innerHTML = `
                    <h3 style="margin: 0 0 15px 0;">‚ö° Insert Existing Action</h3>
                    <p style="margin-bottom: 15px; color: #888; font-size: 0.9em;">
                        Select an action to add to this flow.
                    </p>
                    <div id="actionList" style="max-height: 300px; overflow-y: auto;">
                        ${actions.map(a => `
                            <div class="action-option" data-action-id="${a.id}" data-action-name="${a.action?.name || 'Action'}" style="
                                padding: 12px; margin: 5px 0; background: rgba(255,255,255,0.05);
                                border-radius: 6px; cursor: pointer; border: 2px solid transparent;
                            ">
                                <div style="font-weight: bold;">${a.action?.name || 'Unnamed Action'}</div>
                                <div style="font-size: 0.85em; color: #888; margin-top: 4px;">
                                    Type: ${a.action?.action_type || 'unknown'}
                                    ${a.action?.actions ? ` ‚Ä¢ ${a.action.actions.length} steps` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                // Handle action selection
                dialog.querySelectorAll('.action-option').forEach(option => {
                    option.addEventListener('mouseover', () => option.style.borderColor = '#2196F3');
                    option.addEventListener('mouseout', () => option.style.borderColor = 'transparent');
                    option.addEventListener('click', () => {
                        const actionId = option.dataset.actionId;
                        const actionName = option.dataset.actionName;

                        // Add execute_action step
                        editingFlow.flow.steps.push({
                            step_type: 'execute_action',
                            action_id: actionId,
                            description: `Execute: ${actionName}`
                        });

                        renderFlowSteps();
                        document.body.removeChild(overlay);
                        showToast(`Added action: ${actionName}`, 'success');
                    });
                });

                dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) document.body.removeChild(overlay);
                });

            } catch (error) {
                console.error('Failed to load actions:', error);
                showToast('Failed to load actions', 'error');
            }
        }

        function syncJSONFromBasicForm() {
            if (!editingFlow) return;

            // Build updated flow object from basic form
            const updatedFlow = {
                ...editingFlow.flow,
                name: document.getElementById('editFlowName').value,
                description: document.getElementById('editFlowDescription').value,
                update_interval_seconds: parseInt(document.getElementById('editFlowInterval').value),
                enabled: document.getElementById('editFlowEnabled').checked
            };

            // Update JSON editor
            document.getElementById('editFlowJSON').value = JSON.stringify(updatedFlow, null, 2);
        }

        function syncBasicFormFromJSON() {
            if (!editingFlow) return;

            try {
                const flowData = JSON.parse(document.getElementById('editFlowJSON').value);
                document.getElementById('editFlowName').value = flowData.name || '';
                document.getElementById('editFlowDescription').value = flowData.description || '';
                document.getElementById('editFlowInterval').value = flowData.update_interval_seconds || 60;
                document.getElementById('editFlowEnabled').checked = flowData.enabled !== false;
            } catch (error) {
                console.warn('Failed to sync basic form from JSON:', error);
            }
        }

        function editFlow(deviceId, flowId) {
            // Find the flow to edit
            const flow = flows.find(f => f.device_id === deviceId && f.flow_id === flowId);
            if (!flow) {
                showToast('Flow not found', 'error');
                return;
            }

            // Store reference for saving
            editingFlow = { deviceId, flowId, flow };

            // Populate basic form
            document.getElementById('editFlowName').value = flow.name || '';
            document.getElementById('editFlowDescription').value = flow.description || '';
            document.getElementById('editFlowInterval').value = flow.update_interval_seconds || 60;
            document.getElementById('editFlowEnabled').checked = flow.enabled !== false;

            // Populate JSON editor
            document.getElementById('editFlowJSON').value = JSON.stringify(flow, null, 2);

            // Reset to basic tab
            currentEditTab = 'basic';
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.modal-tab:first-child').classList.add('active');
            document.getElementById('tabBasic').classList.add('active');

            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingFlow = null;
            currentEditTab = 'basic';
        }

        // Handle edit form submission
        document.getElementById('editFlowForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!editingFlow) return;

            let updatedFlow;

            try {
                // If on advanced tab, parse JSON
                if (currentEditTab === 'advanced') {
                    const jsonText = document.getElementById('editFlowJSON').value;
                    updatedFlow = JSON.parse(jsonText);

                    // Validate flow structure
                    if (!updatedFlow.flow_id || !updatedFlow.device_id) {
                        throw new Error('Invalid flow JSON: missing flow_id or device_id');
                    }
                } else {
                    // Use basic form values
                    updatedFlow = {
                        ...editingFlow.flow,
                        name: document.getElementById('editFlowName').value,
                        description: document.getElementById('editFlowDescription').value,
                        update_interval_seconds: parseInt(document.getElementById('editFlowInterval').value),
                        enabled: document.getElementById('editFlowEnabled').checked
                    };
                }

                await window.flowManager.updateFlow(editingFlow.deviceId, editingFlow.flowId, updatedFlow);
                showToast('Flow updated successfully', 'success');
                closeEditModal();
                await loadFlows();
            } catch (error) {
                if (error instanceof SyntaxError) {
                    showToast('Invalid JSON: ' + error.message, 'error', 5000);
                } else {
                    showToast('Failed to update flow: ' + error.message, 'error', 5000);
                }
            }
        });

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });

        // Make functions globally available
        window.loadFlows = loadFlows;
        window.loadAlerts = loadAlerts;
        window.clearAllAlerts = clearAllAlerts;
        window.dismissAlert = dismissAlert;
        window.executeFlow = executeFlow;
        window.deleteFlow = deleteFlow;
        window.editFlow = editFlow;
        window.closeEditModal = closeEditModal;
        window.switchEditTab = switchEditTab;
        window.toggleFlowEnabled = toggleFlowEnabled;
        window.addNewStep = addNewStep;
        window.deleteStep = deleteStep;
        window.moveStepUp = moveStepUp;
        window.moveStepDown = moveStepDown;
        window.updateStepField = updateStepField;
        window.renderFlowSteps = renderFlowSteps;
        window.pauseScheduler = pauseScheduler;
        window.resumeScheduler = resumeScheduler;
        window.loadSchedulerStatus = loadSchedulerStatus;
        window.showInsertSensorDialog = showInsertSensorDialog;
        window.showInsertActionDialog = showInsertActionDialog;

        // Load flows on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadFlows);
        } else {
            loadFlows();
        }

        // Keyboard shortcut for refresh (Ctrl+R / Cmd+R)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showToast('Refreshing...', 'info');
                loadFlows();
            }
        });
    </script>
</body>
</html>
